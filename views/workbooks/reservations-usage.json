{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "parameters": [
            {
              "id": "b58b4eb8-5821-44d2-bc7e-54054df27320",
              "version": "KqlParameterItem/1.0",
              "name": "LookbackPeriod",
              "label": "Lookback Period",
              "type": 4,
              "isRequired": true,
              "value": {
                "durationMs": 2592000000
              },
              "typeSettings": {
                "selectableValues": [
                  {
                    "durationMs": 604800000
                  },
                  {
                    "durationMs": 1209600000
                  },
                  {
                    "durationMs": 2592000000
                  },
                  {
                    "durationMs": 5184000000
                  },
                  {
                    "durationMs": 7776000000
                  }
                ],
                "allowCustom": true
              },
              "timeContext": {
                "durationMs": 86400000
              }
            },
            {
              "id": "08c51931-8b6c-419d-8de2-f9d24e8e6dd7",
              "version": "KqlParameterItem/1.0",
              "name": "ResourceType",
              "label": "Resource Type",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "AzureOptimizationConsumptionV1_CL\r\n| where CollectedDate_t > todatetime('{LookbackPeriod:startISO}') and CollectedDate_t < todatetime('{LookbackPeriod:endISO}') and ChargeType_s == 'Usage' and isnotempty(ReservationName_s)\r\n| distinct MeterCategory_s\r\n| order by MeterCategory_s asc",
              "value": [
                "value::all"
              ],
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "LookbackPeriod",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            {
              "id": "5b2d78e9-7177-4d9b-86fa-2a9b12dd470a",
              "version": "KqlParameterItem/1.0",
              "name": "Reservation",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "AzureOptimizationConsumptionV1_CL\r\n| where CollectedDate_t > todatetime('{LookbackPeriod:startISO}') and CollectedDate_t < todatetime('{LookbackPeriod:endISO}') and ChargeType_s == 'Usage' and isnotempty(ReservationName_s) and MeterCategory_s in ({ResourceType:value})\r\n| distinct ReservationId_g, ReservationName_s\r\n| order by ReservationName_s asc",
              "value": [
                "value::all"
              ],
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "LookbackPeriod",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            {
              "version": "KqlParameterItem/1.0",
              "name": "Aggregator",
              "label": "Aggregator Tag",
              "type": 1,
              "isRequired": true,
              "value": "",
              "timeContext": {
                "durationMs": 2592000000
              },
              "id": "a3fb4877-28ef-43fc-8821-376df486fa2a"
            },
            {
              "id": "aa8a7236-be04-4bac-a536-0bb7fb3ae68b",
              "version": "KqlParameterItem/1.0",
              "name": "BillingAccount",
              "label": "Billing Account ID",
              "type": 1,
              "value": ""
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 0"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "AzureOptimizationConsumptionV1_CL\r\n| where CollectedDate_t > todatetime('{LookbackPeriod:startISO}') and CollectedDate_t < todatetime('{LookbackPeriod:endISO}') and ChargeType_s == 'Usage' and isnotempty(ReservationName_s)\r\n| where ReservationId_g in ({Reservation:value})\r\n| parse AdditionalInfo_s with * \"RINormalizationRatio=\" RINormalizationRatio \"}\" *\r\n| extend UsedRIs = todouble(Quantity_s) * todouble(RINormalizationRatio) / 24\r\n| summarize UsedRIsDaily=round(sum(UsedRIs),2) by UsageDate_t, ReservationName_s, ReservationId_g\r\n| summarize AvgRIsUsedDaily=round(avg(UsedRIsDaily),2) by ReservationName_s, ReservationId_g\r\n| order by AvgRIsUsedDaily\r\n",
          "size": 1,
          "title": "Average Daily Instance Usage by Reservation",
          "timeContextFromParameter": "LookbackPeriod",
          "exportedParameters": [
            {
              "fieldName": "ReservationId_g",
              "parameterName": "selectedReservation"
            },
            {
              "fieldName": "ReservationName_s",
              "parameterName": "selectedReservationName",
              "parameterType": 1
            }
          ],
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "ReservationId_g",
                "formatter": 5
              }
            ],
            "rowLimit": 1000,
            "labelSettings": [
              {
                "columnId": "ReservationName_s",
                "label": "Rerservation"
              },
              {
                "columnId": "AvgRIsUsedDaily",
                "label": "RIs Used Daily (Avg.)"
              }
            ]
          }
        },
        "customWidth": "50",
        "name": "riUsageDailyAverage"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "AzureOptimizationConsumptionV1_CL\r\n| where CollectedDate_t > todatetime('{LookbackPeriod:startISO}') and CollectedDate_t < todatetime('{LookbackPeriod:endISO}') and ChargeType_s == 'Usage' and isnotempty(ReservationName_s)\r\n| where ReservationId_g == '{selectedReservation:value}'\r\n| parse AdditionalInfo_s with * \"RINormalizationRatio=\" RINormalizationRatio \"}\" *\r\n| parse kind = regex flags = Ui Tags_s with * '{Aggregator}=' AggregatorTagMiddle ';' *\r\n| parse kind = regex flags = Ui Tags_s with * '{Aggregator}=' AggregatorTagEnd '}' *\r\n| extend AggregatorTag = iif(isnotempty(AggregatorTagMiddle),AggregatorTagMiddle,AggregatorTagEnd)\r\n| extend UsedRIs = todouble(Quantity_s) * todouble(RINormalizationRatio) / 24\r\n| extend InstanceName = tostring(split(InstanceId_s,'/')[-1])\r\n| summarize UsedRIsDaily=round(sum(UsedRIs),2) by UsageDate_t, InstanceName, AggregatorTag\r\n| summarize AvgRIsUsedDaily=round(avg(UsedRIsDaily),2) by InstanceName, AggregatorTag\r\n| order by AggregatorTag asc, AvgRIsUsedDaily",
          "size": 1,
          "title": "Average Daily Reservation Usage by Instance (select Reservation first)",
          "timeContextFromParameter": "LookbackPeriod",
          "exportFieldName": "ReservationId_g",
          "exportParameterName": "selectedReservation",
          "showExportToExcel": true,
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "ReservationId_g",
                "formatter": 5
              }
            ],
            "rowLimit": 5000,
            "labelSettings": [
              {
                "columnId": "InstanceName",
                "label": "Instance Name"
              },
              {
                "columnId": "AggregatorTag",
                "label": "Aggregator Tag"
              },
              {
                "columnId": "AvgRIsUsedDaily",
                "label": "RIs Used Daily (Avg.)"
              }
            ]
          }
        },
        "customWidth": "50",
        "name": "riUsageDailyAverageByInstance"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/providers/Microsoft.Billing/billingaccounts/{BillingAccount}/reservations?api-version=2020-05-01&$filter=properties/displayName eq '{selectedReservationName}'&selectedState=Succeeded\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value[0].properties\",\"columns\":[]}}]}",
          "size": 4,
          "title": "Reservation Details (select Reservation first)",
          "exportFieldName": "quantity",
          "exportParameterName": "quantityBought",
          "queryType": 12,
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "userFriendlyRenewState",
                "formatter": 5
              },
              {
                "columnMatch": "renew",
                "formatter": 5
              },
              {
                "columnMatch": "archived",
                "formatter": 5
              },
              {
                "columnMatch": "displayProvisioningState",
                "formatter": 5
              },
              {
                "columnMatch": "effectiveDateTime",
                "formatter": 5
              },
              {
                "columnMatch": "purchaseDate",
                "formatter": 5
              },
              {
                "columnMatch": "appliedScopeType",
                "formatter": 5
              },
              {
                "columnMatch": "displayName",
                "formatter": 5
              },
              {
                "columnMatch": "provisioningState",
                "formatter": 5
              },
              {
                "columnMatch": "utilization",
                "formatter": 5
              }
            ],
            "labelSettings": [
              {
                "columnId": "reservedResourceType",
                "label": "Resource Type"
              },
              {
                "columnId": "quantity",
                "label": "Quantity"
              },
              {
                "columnId": "expiryDate",
                "label": "Expiry Date"
              },
              {
                "columnId": "userFriendlyAppliedScopeType",
                "label": "Scope"
              },
              {
                "columnId": "term",
                "label": "Term"
              }
            ]
          }
        },
        "customWidth": "50",
        "name": "reservationDetails"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "AzureOptimizationConsumptionV1_CL\r\n| where CollectedDate_t > todatetime('{LookbackPeriod:startISO}') and CollectedDate_t < todatetime('{LookbackPeriod:endISO}') and ChargeType_s == 'Usage' and isnotempty(ReservationName_s)\r\n| where ReservationId_g == '{selectedReservation:value}'\r\n| parse AdditionalInfo_s with * \"RINormalizationRatio=\" RINormalizationRatio \"}\" *\r\n| parse AdditionalInfo_s with * \"ServiceType=\" VMSize \";\" *\r\n| extend ConsumedSize = iif(isnotempty(VMSize), VMSize, strcat(MeterSubCategory_s, ' ', MeterName_s))\r\n| extend UsedRIs = todouble(Quantity_s) * todouble(RINormalizationRatio) / 24\r\n| summarize round(sum(UsedRIs),1) by UsageDate_t, ConsumedSize, ReservationName_s",
          "size": 0,
          "aggregation": 3,
          "title": "Average RI Usage by Size (select Reservation first)",
          "timeContextFromParameter": "LookbackPeriod",
          "exportFieldName": "ReservationId_g",
          "exportParameterName": "selectedReservation",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "barchart",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "ReservationId_g",
                "formatter": 5
              }
            ],
            "rowLimit": 1000
          },
          "chartSettings": {
            "group": "ConsumedSize",
            "createOtherGroup": null,
            "customThresholdLine": "{quantityBought}",
            "customThresholdLineStyle": 1
          }
        },
        "name": "riUsageDailyAverageBySize"
      }
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }
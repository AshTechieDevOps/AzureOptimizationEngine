{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "017ba09e-f6c5-496e-bc96-b7cfc09cf561",
            "version": "KqlParameterItem/1.0",
            "name": "CostTimeRange",
            "label": "Cost Time Range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 5184000000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "85603c03-1d4b-474b-9cdb-9ba97192fc9e",
            "version": "KqlParameterItem/1.0",
            "name": "InstanceMinCost",
            "label": "Min. instance cost",
            "type": 1,
            "description": "The minimum cost to be considered for an instance to be reported",
            "isRequired": true,
            "value": "50",
            "typeSettings": {
              "paramValidationRules": [
                {
                  "regExp": "^[1-9][0-9]*$",
                  "match": true,
                  "message": "Must be an integer greater than 0"
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "5cf46ddd-b223-4333-a025-65c79eb7ee78",
            "version": "KqlParameterItem/1.0",
            "name": "GrowthPercentage",
            "label": "Growth (%)",
            "type": 1,
            "description": "Cost growth from start to end date",
            "isRequired": true,
            "value": "10",
            "typeSettings": {
              "paramValidationRules": [
                {
                  "regExp": "^[1-9][0-9]*$",
                  "match": true,
                  "message": "Must be an integer greater than 0"
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "506cbda2-cd35-4a10-8e64-812c49d86061",
            "version": "KqlParameterItem/1.0",
            "name": "PerspectiveType",
            "label": "Perspective",
            "type": 2,
            "isRequired": true,
            "value": "MeterCategory_s",
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "jsonData": "[\r\n    {\r\n        \"value\": \"SubscriptionGuid_g\",\r\n        \"label\": \"Subscription\"\r\n    },\r\n    {\r\n        \"value\": \"ResourceGroupName_s\",\r\n        \"label\": \"Resource group\"\r\n    },\r\n    {\r\n        \"value\": \"InstanceId_s\",\r\n        \"label\": \"Resource\"\r\n    },\r\n    {\r\n        \"value\": \"MeterCategory_s\",\r\n        \"label\": \"Meter category\"\r\n    },\r\n    {\r\n        \"value\": \"MeterSubCategory_s\",\r\n        \"label\": \"Meter sub-category\"\r\n    },\r\n    {\r\n        \"value\": \"MeterName_s\",\r\n        \"label\": \"Meter\"\r\n    }\r\n]",
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let Outliers = AzureOptimization_BillingV2_CL\r\n| where UsageDate_t > datetime('{CostTimeRange:startISO}')\r\n| summarize InstanceCost = sum(todouble(Cost_s)) by {PerspectiveType}, UsageDate_t\r\n| where InstanceCost >= {InstanceMinCost}\r\n| order by UsageDate_t\r\n| make-series Cost=sum(InstanceCost) on UsageDate_t in range(startofday(datetime('{CostTimeRange:startISO}')), endofday(ago(6d)), 1d) by {PerspectiveType}\r\n| where Cost[array_length(Cost)-1] > (Cost[1] * {GrowthPercentage})\r\n| extend outliers=series_decompose_anomalies(Cost, 1.5)\r\n| mvexpand outliers, UsageDate_t\r\n| summarize arg_max(todatetime(UsageDate_t), *) by {PerspectiveType}\r\n| where outliers == 1\r\n| top 5 by todouble(Cost[array_length(Cost)-1])\r\n| distinct {PerspectiveType};\r\nAzureOptimization_BillingV2_CL\r\n| where {PerspectiveType} in (Outliers) and UsageDate_t > datetime('{CostTimeRange:startISO}') and ChargeType_s == 'Usage'\r\n| summarize sum(todouble(Cost_s)) by bin(UsageDate_t, 1d), {PerspectiveType}\r\n| render timechart",
        "size": 0,
        "title": "Outliers",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "CostTimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "50",
      "name": "outliers"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let CostsGrowing = AzureOptimization_BillingV2_CL\r\n| where UsageDate_t > datetime('{CostTimeRange:startISO}') and ChargeType_s == 'Usage'\r\n| summarize InstanceCost = sum(todouble(Cost_s)) by {PerspectiveType}, UsageDate_t\r\n| where InstanceCost >= {InstanceMinCost}\r\n| order by UsageDate_t\r\n| make-series Cost=sum(InstanceCost) on UsageDate_t in range(startofday(datetime('{CostTimeRange:startISO}')), endofday(ago(6d)), 1d) by {PerspectiveType}\r\n| where Cost[array_length(Cost)-1] > (Cost[1] * {GrowthPercentage})\r\n| distinct {PerspectiveType};\r\nAzureOptimization_BillingV2_CL\r\n| where {PerspectiveType} in (CostsGrowing) and UsageDate_t > datetime('{CostTimeRange:startISO}') and ChargeType_s == 'Usage'\r\n| summarize sum(todouble(Cost_s)) by bin(UsageDate_t, 1d), {PerspectiveType}\r\n| render timechart",
        "size": 0,
        "title": "Growing",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "CostTimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "50",
      "name": "costsGrowing"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/6cb52f26-4370-4d50-afa5-b47282f84704/resourceGroups/CostOptimizationStorageAccount/providers/Microsoft.OperationalInsights/workspaces/FF-Optimization"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
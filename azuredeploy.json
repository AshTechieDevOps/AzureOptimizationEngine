{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "projectName": {
            "type": "String"
        },
        "projectLocation": {
            "type": "String"
        },
        "_artifactsLocation": {
            "type": "string",
            "defaultValue": "[deployment().properties.templateLink.uri]",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated"
            }
        },
        "logAnalyticsReuse": {
            "type": "bool"
        },
        "logAnalyticsRetentionDays": {
            "type": "int",
            "defaultValue": 120
        },
        "sqlBackupRetentionDays": {
            "type": "int",
            "defaultValue": 14
        },
        "sqlAdminLogin": {
            "type": "String"
        },
        "sqlAdminPassword": {
            "type": "securestring"
        },
        "cloudEnvironment": {
            "type": "String",
            "defaultValue": "AzureCloud"
        },
        "authenticationOption": {
            "type": "String",
            "defaultValue": "RunAsAccount"
        },
        "baseTime": {
            "type": "string",
            "defaultValue": "[utcNow('u')]",
            "metadata": {
                "description": "Base time for all automation runbook schedules."
            }
        },
        "argDiskExportJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the ARG Disk Export job schedule creation - create a unique before deploy"
            }
        },
        "argVmExportJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the ARG VM Export job schedule creation - create a unique before deploy"
            }
        },
        "advisorExportJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the Advisor Export job schedule creation - create a unique before deploy"
            }
        },
        "argDiskIngestJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the ARG Disk Ingest job schedule creation - create a unique before deploy"
            }
        },
        "argVmIngestJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the ARG VM Ingest job schedule creation - create a unique before deploy"
            }
        },
        "advisorIngestJobId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "GUID for the Advisor Ingest job schedule creation - create a unique before deploy"
            }
        }
    },
    "variables": {
        "storageAccountName": "[concat(tolower(parameters('projectName')),'sa')]",
        "automationAccountName": "[concat(parameters('projectName'),'-auto')]",
        "sqlServerName": "[concat(parameters('projectName'),'-sql')]",
        "logAnalyticsWorkspaceName": "[concat(parameters('projectName'),'-la')]",
        "sqlDatabaseName": "azureoptimization",
        "advisorCostsContainerName": "advisorexports",
        "argVmContainerName": "argvmexports",
        "argDiskContainerName": "argdiskexports",
        "advisorExportsRunbookName": "Export-AdvisorCostRecommendationsToBlobStorage",
        "argVmExportsRunbookName": "Export-ARGVirtualMachinesPropertiesToBlobStorage",
        "argDisksExportsRunbookName": "Export-ARGManagedDisksPropertiesToBlobStorage",
        "csvIngestRunbookName": "Ingest-OptimizationCSVExportsToLogAnalytics",
        "advisorExportsScheduleName": "AzureOptimization_ExportAdvisorWeekly",
        "argExportsScheduleName": "AzureOptimization_ExportARGDaily",
        "argDiskIngestScheduleName": "AzureOptimization_IngestARGDisksDaily",
        "argVmIngestScheduleName": "AzureOptimization_IngestARGVMsDaily",
        "advisorIngestScheduleName": "AzureOptimization_IngestAdvisorCostWeekly",
        "apiVersions": {
            "operationalInsights": "2020-03-01-preview",
            "automation": "2018-06-30",
            "storage": "2019-06-01",
            "sql": "2019-06-01-preview"
        },
        "Az.Accounts": {
            "name": "Az.Accounts",
            "url": "https://www.powershellgallery.com/api/v2/package/Az.Accounts/1.8.0"
        },
        "psModules": [
            {
                "name": "Az.Advisor",
                "url": "https://www.powershellgallery.com/api/v2/package/Az.Advisor/1.1.1"
            },
            {
                "name": "Az.Compute",
                "url": "https://www.powershellgallery.com/api/v2/package/Az.Compute/4.1.0"
            },
            {
                "name": "Az.OperationalInsights",
                "url": "https://www.powershellgallery.com/api/v2/package/Az.OperationalInsights/2.0.0"
            },
            {
                "name": "Az.ResourceGraph",
                "url": "https://www.powershellgallery.com/api/v2/package/Az.ResourceGraph/0.7.7"
            },
            {
                "name": "Az.Storage",
                "url": "https://www.powershellgallery.com/api/v2/package/Az.Storage/2.0.0"
            }
        ],
        "runbooks": [
            {
                "name": "[variables('advisorExportsRunbookName')]",
                "version": "1.0.0.0",
                "description": "Exports Azure Advisor Cost recommendations to Blob Storage using the Advisor API",
                "type": "PowerShell",
                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('advisorExportsRunbookName'),'.ps1', parameters('_artifactsLocationSasToken')))]"
            },
            {
                "name": "[variables('argDisksExportsRunbookName')]",
                "version": "1.0.0.0",
                "description": "Exports Managed Disks properties to Blob Storage using Azure Resource Graph",
                "type": "PowerShell",
                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argDisksExportsRunbookName'),'.ps1', parameters('_artifactsLocationSasToken')))]"
            },
            {
                "name": "[variables('argVmExportsRunbookName')]",
                "version": "1.0.0.0",
                "description": "Exports Virtual Machine properties to Blob Storage using Azure Resource Graph",
                "type": "PowerShell",
                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('argVmExportsRunbookName'),'.ps1', parameters('_artifactsLocationSasToken')))]"
            },
            {
                "name": "[variables('csvIngestRunbookName')]",
                "version": "1.0.0.0",
                "description": "Ingests CSV blobs as custom logs to Log Analytics",
                "type": "PowerShell",
                "scriptUri": "[uri(parameters('_artifactsLocation'), concat('runbooks/data-collection/',variables('csvIngestRunbookName'),'.ps1', parameters('_artifactsLocationSasToken')))]"
            }
        ],
        "automationVariables": [
            {
                "name": "AzureOptimization_CloudEnvironment",
                "description": "Azure Cloud environment (e.g., AzureCloud, AzureChinaCloud, etc.)",
                "value": "[concat('\"',parameters('cloudEnvironment'),'\"')]"
            },
            {
                "name": "AzureOptimization_AuthenticationOption",
                "description": "Runbook authentication type (Run As Account or Managed Identity)",
                "value": "[concat('\"',parameters('authenticationOption'),'\"')]"
            },
            {
                "name": "AzureOptimization_StorageSink",
                "description": "The Azure Storage Account where data source exports are dumped to",
                "value": "[concat('\"',variables('storageAccountName'),'\"')]"
            },
            {
                "name": "AzureOptimization_StorageSinkRG",
                "description": "The resource group for the Azure Storage Account sink",
                "value": "[concat('\"',resourceGroup().name,'\"')]"
            },
            {
                "name": "AzureOptimization_StorageSinkSubId",
                "description": "The subscription Id for the Azure Storage Account sink",
                "value": "[concat('\"',subscription().subscriptionId,'\"')]"
            },
            {
                "name": "AzureOptimization_AdvisorCostContainer",
                "description": "The Storage Account container where Azure Advisor exports are dumped to",
                "value": "[concat('\"',variables('advisorCostsContainerName'),'\"')]"
            },
            {
                "name": "AzureOptimization_ARGDiskContainer",
                "description": "The Storage Account container where Azure Resource Graph Managed Disks exports are dumped to",
                "value": "[concat('\"',variables('argDiskContainerName'),'\"')]"
            },
            {
                "name": "AzureOptimization_ARGVMContainer",
                "description": "The Storage Account container where Azure Resource Graph Virtual Machine exports are dumped to",
                "value": "[concat('\"',variables('argVmContainerName'),'\"')]"
            },
            {
                "name": "AzureOptimization_ReferenceRegion",
                "description": "The Azure region used as a reference for getting details about Azure VM sizes available",
                "value": "[concat('\"',parameters('projectLocation'),'\"')]"
            },
            {
                "name": "AzureOptimization_SQLServerDatabase",
                "description": "The Azure SQL Database name for the ingestion control and recommendations tables",
                "value": "[concat('\"',variables('sqlDatabaseName'),'\"')]"
            },
            {
                "name": "AzureOptimization_LogAnalyticsChunkSize",
                "description": "The size (in rows) for each chunk of Log Analytics ingestion request",
                "value": "[concat('\"','10000','\"')]"
            },
            {
                "name": "AzureOptimization_StorageBlobsPageSize",
                "description": "The size (in blobs count) for each page of Storage Account container blob listing",
                "value": "[concat('\"','1000','\"')]"
            },
            {
                "name": "AzureOptimization_LogAnalyticsLogPrefix",
                "description": "The prefix for all Azure Optimization custom log tables in Log Analytics",
                "value": "[concat('\"','AzureOptimization','\"')]"
            }
        ]
    },
    "resources": [
        // Log Analytics Workspace
        {
            "condition": "[not(parameters('logAnalyticsReuse'))]",
            "type": "microsoft.operationalinsights/workspaces",
            "apiVersion": "[variables('apiVersions').operationalInsights]",
            "name": "[variables('logAnalyticsWorkspaceName')]",
            "location": "[parameters('projectLocation')]",
            "properties": {
                "sku": {
                    "name": "pergb2018"
                },
                "retentionInDays": "[parameters('logAnalyticsRetentionDays')]"
            }
        },
        // Storage Account
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('projectLocation')]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [
                    ],
                    "ipRules": [
                    ],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "enabled": true
                        },
                        "blob": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                },
                "accessTier": "Cool"
            }
        },
        // Storage Account Blob Services
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[concat(variables('storageAccountName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "sku": {
                "name": "Standard_LRS"
            },
            "properties": {
                "cors": {
                    "corsRules": [
                    ]
                },
                "deleteRetentionPolicy": {
                    "enabled": false
                }
            }
        },
        // Storage Account ARG Disk exports container
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[concat(variables('storageAccountName'), '/default/', variables('argDiskContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        // Storage Account ARG VM exports container
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[concat(variables('storageAccountName'), '/default/', variables('argVmContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        // Storage Account Advisor Cost exports container
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[concat(variables('storageAccountName'), '/default/', variables('advisorCostsContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        // Storage Account Recommendations exports container
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "[variables('apiVersions').storage]",
            "name": "[concat(variables('storageAccountName'), '/default/recommendationsexports')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        // Azure SQL Server
        {
            "type": "Microsoft.Sql/servers",
            "apiVersion": "[variables('apiVersions').sql]",
            "name": "[variables('sqlServerName')]",
            "location": "[parameters('projectLocation')]",
            "kind": "v12.0",
            "properties": {
                "administratorLogin": "[parameters('sqlAdminLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "version": "12.0",
                "publicNetworkAccess": "Enabled"
            },
            "resources": [
                {
                    "type": "firewallRules",
                    "apiVersion": "[variables('apiVersions').sql]",
                    "name": "AllowAllWindowsAzureIps",
                    "location": "[parameters('projectLocation')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
                    ],
                    "properties": {
                        "endIpAddress": "0.0.0.0",
                        "startIpAddress": "0.0.0.0"
                    }
                }
            ]
        },
        // Azure SQL Database
        {
            "type": "Microsoft.Sql/servers/databases",
            "apiVersion": "[variables('apiVersions').sql]",
            "name": "[concat(variables('sqlServerName'), '/', variables('sqlDatabaseName'))]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
            ],
            "sku": {
                "name": "GP_S_Gen5",
                "tier": "GeneralPurpose",
                "family": "Gen5",
                "capacity": 1
            },
            "kind": "v12.0,user,vcore,serverless",
            "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 3221225472,
                "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
                "zoneRedundant": false,
                "readScale": "Disabled",
                "readReplicaCount": 0,
                "autoPauseDelay": 60,
                "storageAccountType": "GRS",
                "minCapacity": 0.5
            }
        },
        // Azure SQL backup retention policy
        {
            "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",
            "apiVersion": "[variables('apiVersions').sql]",
            "name": "[concat(variables('sqlServerName'), '/', variables('sqlDatabaseName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Sql/servers/databases', variables('sqlServerName'), variables('sqlDatabaseName'))]",
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
            ],
            "properties": {
                "retentionDays": "[parameters('sqlBackupRetentionDays')]"
            }
        },
        // Automation Account
        {
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "[variables('apiVersions').automation]",
            "name": "[variables('automationAccountName')]",
            "location": "[parameters('projectLocation')]",
            "properties": {
                "sku": {
                    "name": "Basic"
                }
            }
        },
        // Automation Modules (Az.Account)
        {
            "comments": "provision the Az.Accounts module first since others are depenedent on it",
            "name": "[concat(variables('automationAccountName'), '/', variables('Az.Accounts').name)]",
            "type": "Microsoft.Automation/automationAccounts/modules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "contentLink": {
                    "uri": "[variables('Az.Accounts').url]"
                }
            }
        },
        // Automation Modules (other)
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('psModules')[copyIndex()].name)]",
            "type": "Microsoft.Automation/automationAccounts/modules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('Az.Accounts').name]"
            ],
            "copy": {
                "name": "modulesLoop",
                "count": "[length(variables('psModules'))]"
            },
            "properties": {
                "contentLink": {
                    "uri": "[variables('psModules')[copyIndex()].url]"
                }
            }
        },
        // Automation Runbooks
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('runbooks')[copyIndex()].name)]",
            "type": "Microsoft.Automation/automationAccounts/runbooks",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('Az.Accounts').name]",
                "modulesLoop"
            ],
            "copy": {
                "name": "runbooksLoop",
                "count": "[length(variables('runbooks'))]"
            },
            "properties": {
                "runbookType": "[variables('runbooks')[copyIndex()].type]",
                "logProgress": false,
                "logVerbose": false,
                "description": "[variables('runbooks')[copyIndex()].description]",
                "publishContentLink": {
                    "uri": "[variables('runbooks')[copyIndex()].scriptUri]",
                    "version": "[variables('runbooks')[copyIndex()].version]"
                }
            }
        },
        // Automation Variables
        {
            "type": "Microsoft.Automation/automationAccounts/variables",
            "apiVersion": "[variables('apiVersions').automation]",
            "name": "[concat(variables('automationAccountName'), '/', variables('automationVariables')[copyIndex()].name)]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "copy": {
                "name": "variableLoop",
                "count": "[length(variables('automationVariables'))]"
            },
            "properties": {
                "description": "[variables('automationVariables')[copyIndex()].description]",
                "value": "[variables('automationVariables')[copyIndex()].value]"
            }
        },
        // Automation Variables (SQL Server Hostname)
        {
            "type": "Microsoft.Automation/automationAccounts/variables",
            "apiVersion": "[variables('apiVersions').automation]",
            "name": "[concat(variables('automationAccountName'), '/AzureOptimization_SQLServerHostname')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
            ],
            "properties": {
                "description": "The Azure SQL Server hostname for the ingestion control and recommendations tables",
                "value": "[concat('\"', reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), providers('Microsoft.Sql', 'servers').apiVersions[0]).fullyQualifiedDomainName, '\"')]"
            }
        },
        // Automation Credentials
        {
            "name": "[concat(variables('automationAccountName'), '/AzureOptimization_SQLServerCredential')]",
            "type": "Microsoft.Automation/automationAccounts/credentials",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Azure Optimization SQL Database Credentials",
                "password": "[parameters('sqlAdminPassword')]",
                "userName": "[parameters('sqlAdminLogin')]"
            }
        },
        // Automation ARG Exports Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('argExportsScheduleName'))]",
            "type": "Microsoft.Automation/automationAccounts/schedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Starts the daily Azure Resource Graph exports",
                "expiryTime": "9999-12-31T17:59:00-06:00",
                "isEnabled": true,
                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H')]",
                "interval": 1,
                "frequency": "Day"
            }
        },
        // Automation Advisor Exports Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('advisorExportsScheduleName'))]",
            "type": "Microsoft.Automation/automationAccounts/schedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Starts the weekly Azure Advisor exports",
                "expiryTime": "9999-12-31T17:59:00-06:00",
                "isEnabled": true,
                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H15M')]",
                "interval": 1,
                "frequency": "Week"
            }
        },
        // Automation ARG Disk Ingest Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('argDiskIngestScheduleName'))]",
            "type": "Microsoft.Automation/automationAccounts/schedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Starts the daily Azure Resource Graph Managed Disks ingests",
                "expiryTime": "9999-12-31T17:59:00-06:00",
                "isEnabled": true,
                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H30M')]",
                "interval": 1,
                "frequency": "Day"
            }
        },
        // Automation ARG VM Ingest Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('argVmIngestScheduleName'))]",
            "type": "Microsoft.Automation/automationAccounts/schedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Starts the daily Azure Resource Graph Virtual Machine ingests",
                "expiryTime": "9999-12-31T17:59:00-06:00",
                "isEnabled": true,
                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H30M')]",
                "interval": 1,
                "frequency": "Day"
            }
        },
        // Automation Advisor Exports Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', variables('advisorIngestScheduleName'))]",
            "type": "Microsoft.Automation/automationAccounts/schedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]"
            ],
            "properties": {
                "description": "Starts the weekly Azure Advisor Cost ingests",
                "expiryTime": "9999-12-31T17:59:00-06:00",
                "isEnabled": true,
                "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H45M')]",
                "interval": 1,
                "frequency": "Week"
            }
        },
        // Automation ARG Disk Exports Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('argDiskExportJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('argExportsScheduleName')]",
                "modulesLoop",
                "[variables('argDisksExportsRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('argExportsScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('argDisksExportsRunbookName')]"
                }
            }
        },
        // Automation ARG VM Exports Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('argVmExportJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('argExportsScheduleName')]",
                "modulesLoop",
                "[variables('argVmExportsRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('argExportsScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('argVmExportsRunbookName')]"
                }
            }
        },
        // Automation Advisor Exports Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('advisorExportJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('advisorExportsScheduleName')]",
                "modulesLoop",
                "[variables('advisorExportsRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('advisorExportsScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('advisorExportsRunbookName')]"
                }
            }
        },
        // Automation ARG Disk Ingest Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('argDiskIngestJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('argDiskIngestScheduleName')]",
                "modulesLoop",
                "[variables('csvIngestRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('argDiskIngestScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('csvIngestRunbookName')]"
                },
                "parameters": {
                    "StorageSinkContainer": "[variables('argDiskContainerName')]"
                }
            }
        },
        // Automation ARG VM Ingest Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('argVmIngestJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('argVmIngestScheduleName')]",
                "modulesLoop",
                "[variables('csvIngestRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('argVmIngestScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('csvIngestRunbookName')]"
                },
                "parameters": {
                    "StorageSinkContainer": "[variables('argVmContainerName')]"
                }
            }
        },
        // Automation Advisor Ingest Job Schedule
        {
            "name": "[concat(variables('automationAccountName'), '/', parameters('advisorIngestJobId'))]",
            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
            "apiVersion": "[variables('apiVersions').automation]",
            "location": "[parameters('projectLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', variables('automationAccountName'))]",
                "[variables('advisorIngestScheduleName')]",
                "modulesLoop",
                "[variables('csvIngestRunbookName')]"
            ],
            "properties": {
                "schedule": {
                    "name": "[variables('advisorIngestScheduleName')]"
                },
                "runbook": {
                    "name": "[variables('csvIngestRunbookName')]"
                },
                "parameters": {
                    "StorageSinkContainer": "[variables('advisorCostsContainerName')]"
                }
            }
        }
    ]
}